# Elasticsearch 核心概念

Elasticsearch 是一个高度可扩展的开源全文搜索和分析引擎。它允许您快速地、近实时地对大数据进行存储、搜索和分析。它通常用来支撑有复杂的数据搜索需求的企业级应用。Elasticsearch 基于 Apache Lucene 构建，作为一个非常流行的开源软件的同时，也有相应的公司提供商业支持，使之非常适合企业用户使用。在使用 Elasticsearch 之前，首先介绍其中的一些基本概念。

在使用 Elasticsearch 之前，首先介绍其中的一些基本概念。

## 近实时（NRT）

Elasticsearch 是一个接近实时（Near Realtime，简称 NRT）的搜索平台。 这意味着从索引文档到可搜索的时间有一个轻微的延迟（通常为1秒）。


## 集群（Cluster）

集群是一个或多个节点的集合，用来保存应用的全部数据并提供基于全部节点的集成式索引和搜索功能。每个集群都需要有一个惟一的名称，默认是“elasticsearch”。此名称很重要，因为如果节点设置为通过其名称加入集群，则节点只能是集群的一部分。

不要在不同的环境中重复使用相同的集群名称，否则可能会导致加入错误集群的节点。 例如，可以在针对开发、暂存和生产环境的集群中使用logging-dev 、logging-stage 和 logging-prod。

请注意，当一个集群只有一个节点时，通常是有效的和完美的。 然而需要考虑在部署多个独立的集群，每个集群都要有自己唯一的集群名称。

## 节点

节点是一个集群中的单台服务器，用来保存数据并参与整个集群的索引和搜索操作。就像一个集群一样，一个节点由一个名称标识，默认情况下它是一个随机的通用唯一标识符（UUID），在启动时分配给该节点。如果不想使用默认值，可以定义任何所需的节点名称。此名称对于管理目的非常重要，您需要确定网络中哪些服务器对应于 Elasticsearch 集群中的哪些节点。

可以将节点配置为通过集群名称加入特定集群。默认情况下，每个节点都设置为加入名为 elasticsearch 的集群，这意味着如果您在网络上启动多个节点，并且假设它们可以发现彼此，则它们将自动形成并加入名为 elasticsearch 的单个集群。

在单个集群中，您可以拥有任意数量的节点。此外，如果您的网络上当前没有其他 Elasticsearch 节点运行，则启动单个节点将默认形成名为 elasticsearch  的新单节点集群。

## 索引（Index）

索引是相似文档的集合。索引中的内容与应用本身的业务相关。比如电子商务应用可以使用索引来保存产品数据、订单数据和客户数据等。每个索引都有一个名称，通过该名称可以对索引中包含的文档进行添加、更新、删除和搜索等操作。
 
在单个集群中，您可以根据需要定义任意数量的索引。


## 类型（Type）

类型是对一个索引中包含的文档的进一步细分。一般根据文档的公共属性来进行划分。比如在电子商务应用的产品数据索引中，可以根据产品的特征划分成不同的类型，如一般产品、虚拟产品、数字产品等。

## 文档（Document）

文档是进行索引的基本单位，与索引中的一个类型相对应。比如产品数据索引中一般产品类型中的每个具体的产品可以有一个文档与之对应。文档使用 JSON 格式来表示。

在索引/类型中，您可以存储任意数量的文档。 请注意，虽然文档物理上驻留在索引中，但实际上文档必须是索引中的类型。


## 分片和副本（Shards & Replicas）

企业应用需要存储的数据量一般比较巨大，超出单个节点所能处理的范围。Elasticsearch 允许把索引划分成多个分片（shard）来存储索引的部分数据。Elasticsearch 会负责处理分片的分配和聚合。从可靠性的角度出发，对于一个分片中的数据，应该有至少一个副本（replica）。Elasticsearch 中每个索引可以划分成多个分片，而且有多个副本。Elasticsearch 会自动管理集群中节点的分片和副本，对开发人员是透明的。


### 设置分片的原因 

主要原因是：

* 它允许您水平分割/缩放您的内容卷
* 它允许您跨分片（可能在多个节点上）分布和并行操作，从而提高性能/吞吐量

碎片如何分布、文档如何聚合搜索请求等，这些机制都由 Elasticsearch 完全管理，并且对用户是透明的。

由于在云环境中，故障不可避免，所以一定要有故障转移机制，以防万一某个分片/节点故障。为此，Elasticsearch 允许您将索引的碎片的一个或多个副本转换为所谓的副本碎分片，或简称为副本。

### 设置副本的原因 

主要原因是：

* 在碎片/节点故障的情况下提供高可用性。因此，副本分片不能部署在从其复制的原始/主分片相同的节点上。
* 它允许您扩展搜索量/吞吐量，因为搜索可以并行地在所有副本上执行。

总而言之，每个索引可以拆分成多个分片。索引也可以复制为零（意味着没有副本）或更多次。一旦复制，每个索引将具有主分片和副本分片。可以在创建索引时为每个索引定义分片和副本的数量。创建索引后，您可以随时动态更改副本数，但不能随后更改分片数。

默认情况下，Elasticsearch 每个索引分配5 主分片和1个副本，这意味着，你的集群至少有两个节点，你的索引将有5个主要碎片和另外5个副本碎片（1完整的副本），每个索引共10分片。

>注意:每个Elasticsearch 分片 是一个 Lucene 索引。在一个 Lucene 索引中有文档数的最多限制。从[LUCENE-5843](https://issues.apache.org/jira/browse/LUCENE-5843) 版本开始，限制为 `2,147,483,519`（等于`Integer.MAX_VALUE - 128`）个文档。您可以使用 [_cat/shards](https://www.elastic.co/guide/en/elasticsearch/reference/current/cat-shards.html)  api 监视分片大小。


